// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 Int       @id @default(autoincrement())
  uuid               String    @unique @default(uuid())
  email              String    @unique
  password_hash      String
  name               String
  phone              String?
  birth_date         DateTime?
  gender             String?   // 'male', 'female', 'other', 'prefer_not_to_say'
  blood_type         String?   // 'A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-'
  address            String?
  emergency_contact  String?
  created_at         DateTime  @default(now())
  updated_at         DateTime  @default(now()) @updatedAt
  is_active          Boolean   @default(true)

  // Relações
  appointments      Appointment[]
  prescriptions     Prescription[]
  medical_exams     MedicalExam[]
  health_metrics    HealthMetric[]
  reminders         Reminder[]
  settings          UserSettings?
  access_logs       AccessLog[]

  @@map("users")
}

// Tabela de Médicos (atualizada)
model Doctor {
  id              Int       @id @default(autoincrement())
  uuid            String    @unique @default(uuid())
  name            String
  specialty       String
  license_number  String?   @unique
  email           String?   @unique
  phone           String?
  is_active       Boolean   @default(true)
  created_at      DateTime  @default(now())

  // Relações
  appointments    Appointment[]
  prescriptions   Prescription[]
  doctor_services DoctorService[] // Nova relação

  @@map("doctors")
}
// Tabela de Hospitais (atualizada)
model Hospital {
  id         Int       @id @default(autoincrement())
  name       String
  address    String?
  phone      String?
  email      String?
  is_active  Boolean   @default(true)
  created_at DateTime  @default(now())

  // Relações
  appointments Appointment[]
  hospital_services HospitalService[] // Nova relação

  @@map("hospitals")
}

// Tabela de Consultas (ATUALIZADA)
model Appointment {
  id                 Int       @id @default(autoincrement())
  uuid               String    @unique @default(uuid())
  consultation_code  String    @unique
  scheduled_date     DateTime
  start_time         String
  end_time           String
  status             String    @default("scheduled") // 'scheduled', 'completed', 'cancelled', 'no_show'
  reason             String?
  diagnosis          String?
  notes              String?
  created_at         DateTime  @default(now())
  updated_at         DateTime  @default(now()) @updatedAt

  // NOVOS CAMPOS para compatibilidade com frontend
  patient_name       String    // Nome do paciente no momento do agendamento
  service_name       String    // Nome do serviço no momento do agendamento
  doctor_name        String    // Nome do médico no momento do agendamento
  hospital_name      String    // Nome do hospital no momento do agendamento

  // Relações (atualizadas)
  user_id     Int
  user        User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  doctor_id   Int?
  doctor      Doctor?   @relation(fields: [doctor_id], references: [id], onDelete: SetNull)
  hospital_id Int?
  hospital    Hospital? @relation(fields: [hospital_id], references: [id], onDelete: SetNull)
  service_id  Int?
  service     Service?  @relation(fields: [service_id], references: [id], onDelete: SetNull)

  prescriptions Prescription[]
  medical_exams MedicalExam[]

  @@map("appointments")
}



// Tabela de Serviços (nova)
model Service {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  duration    Int      @default(60) // Duração em minutos
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @default(now()) @updatedAt

  // Relações
  appointments Appointment[]

  @@map("services")
}

// NOVA TABELA: Relação entre Médicos e Serviços
model DoctorService {
  id         Int      @id @default(autoincrement())
  doctor_id  Int
  service_id Int
  created_at DateTime @default(now())

  // Relações
  doctor  Doctor  @relation(fields: [doctor_id], references: [id], onDelete: Cascade)
  service Service @relation(fields: [service_id], references: [id], onDelete: Cascade)

  @@unique([doctor_id, service_id])
  @@map("doctor_services")
}


// NOVA TABELA: Relação entre Hospitais e Serviços
model HospitalService {
  id         Int      @id @default(autoincrement())
  hospital_id Int
  service_id Int
  created_at DateTime @default(now())

  // Relações
  hospital Hospital @relation(fields: [hospital_id], references: [id], onDelete: Cascade)
  service Service  @relation(fields: [service_id], references: [id], onDelete: Cascade)

  @@unique([hospital_id, service_id])
  @@map("hospital_services")
}

model Prescription {
  id              Int       @id @default(autoincrement())
  uuid            String    @unique @default(uuid())
  issue_date      DateTime
  expiration_date DateTime?
  instructions    String?
  created_at      DateTime  @default(now())

  // Relações
  appointment_id Int?
  appointment    Appointment? @relation(fields: [appointment_id], references: [id], onDelete: Cascade)
  doctor_id      Int?
  doctor         Doctor?     @relation(fields: [doctor_id], references: [id], onDelete: SetNull)
  user_id        Int
  user           User        @relation(fields: [user_id], references: [id], onDelete: Cascade)

  medications PrescribedMedication[]

  @@map("prescriptions")
}

model DoctorAvailability {
  id           Int      @id @default(autoincrement())
  doctor_id    Int
  day_of_week  Int      // 0 = Domingo, 1 = Segunda, ..., 6 = Sábado
  start_time   String
  end_time     String
  is_available Boolean  @default(true)
  created_at   DateTime @default(now())
  updated_at   DateTime @default(now()) @updatedAt

  // Relações
  doctor Doctor @relation(fields: [doctor_id], references: [id], onDelete: Cascade)

  @@unique([doctor_id, day_of_week])
  @@map("doctor_availabilities")
}

model PrescribedMedication {
  id               Int     @id @default(autoincrement())
  medication_name  String
  dosage           String?
  frequency        String?
  duration         String?
  instructions     String?

  // Relações
  prescription_id Int
  prescription    Prescription @relation(fields: [prescription_id], references: [id], onDelete: Cascade)

  @@map("prescribed_medications")
}

model MedicalExam {
  id           Int       @id @default(autoincrement())
  uuid         String    @unique @default(uuid())
  exam_type    String
  exam_date    DateTime
  results      String?
  lab_name     String?
  doctor_notes String?
  created_at   DateTime  @default(now())

  // Relações
  user_id        Int
  user           User        @relation(fields: [user_id], references: [id], onDelete: Cascade)
  appointment_id Int?
  appointment    Appointment? @relation(fields: [appointment_id], references: [id], onDelete: SetNull)

  @@map("medical_exams")
}

model UserSettings {
  id                   Int      @id @default(autoincrement())
  email_notifications  Boolean  @default(true)
  sms_notifications    Boolean  @default(false)
  appointment_reminders Boolean @default(true)
  medication_reminders Boolean @default(true)
  data_sharing         Boolean  @default(false)
  health_records_access String  @default("me") // 'me', 'doctors', 'all'
  theme                String   @default("light") // 'light', 'dark', 'system'
  language             String   @default("portuguese") // 'portuguese', 'english', 'spanish'
  updated_at           DateTime @default(now()) @updatedAt

  // Relações
  user_id Int   @unique
  user    User  @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

model HealthMetric {
  id          Int       @id @default(autoincrement())
  metric_type String
  value       String
  unit        String?
  measured_at DateTime  @default(now())
  notes       String?
  created_at  DateTime  @default(now())

  // Relações
  user_id Int
  user    User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("health_metrics")
}

// NOVA TABELA: Bloqueios de agenda
model ScheduleBlock {
  id           Int      @id @default(autoincrement())
  doctor_id    Int?
  hospital_id  Int?
  start_time   DateTime
  end_time     DateTime
  reason       String
  is_recurring Boolean  @default(false)
  created_at   DateTime @default(now())

  // Relações
  doctor   Doctor?   @relation(fields: [doctor_id], references: [id], onDelete: Cascade)
  hospital Hospital? @relation(fields: [hospital_id], references: [id], onDelete: Cascade)

  @@map("schedule_blocks")
}

model Reminder {
  id             Int       @id @default(autoincrement())
  type           String    // 'appointment', 'medication', 'general'
  title          String
  message        String?
  scheduled_time DateTime
  is_completed   Boolean   @default(false)
  created_at     DateTime  @default(now())

  // Relações
  user_id Int
  user    User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("reminders")
}

model AccessLog {
  id         Int      @id @default(autoincrement())
  action     String
  ip_address String?
  user_agent String?
  created_at DateTime @default(now())

  // Relações
  user_id Int?
  user    User?  @relation(fields: [user_id], references: [id], onDelete: SetNull)

  @@map("access_logs")
}